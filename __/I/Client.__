subclass Client
  __init__
    init
    appnew
    appreconnect
    idle
  end

  let SESSION_PID = getenv ("SESSION_PID");
  let SESSION_WRFIFO = getenv ("SESSION_WRFIFO");
  let SESSION_RDFIFO = getenv ("SESSION_RDFIFO");
  let SESSION_RDFIFO_FD = NULL;
  let SESSION_WRFIFO_FD = NULL;

  def init ()
    __->__ ("IClient", "SESSION_WRFIFO_FD", open (SESSION_WRFIFO, O_WRONLY), "Class::vset");
    __->__ ("IClient", "SESSION_RDFIFO_FD", open (SESSION_RDFIFO, O_RDONLY), "Class::vset");
  end

  def appnew (s)
    variable apps = assoc_get_keys (App->APPS);

    Rline.set (s);
    Rline.prompt (s, s._lin, s._col);

    variable saved = Input->rmap.right;
    Input->rmap.right = [saved, Input->F2];
    () = Rline.commandcmp (s, apps;already_filtered);
    Input->rmap.right = saved;

    ifnot (any (apps == s.argv[0]))
      return;

    Api.reset_app ();

    if (This.has.sigint)
      {
      variable handl;
      signal (SIGINT, SIG_IGN, &handl);
      }

    variable is_su = __get_qualifier_as (Integer_Type, "issu",
      qualifier ("issu"), 0);

    Sock.send_int (SESSION_WRFIFO_FD, Api->APP_CON_NEW);
    () = Sock.get_int (SESSION_RDFIFO_FD);
    Sock.send_str (SESSION_WRFIFO_FD, s.argv[0]);
    () = Sock.get_int (SESSION_RDFIFO_FD);
    Sock.send_int (SESSION_WRFIFO_FD, is_su);

    variable retval = Sock.get_int (SESSION_RDFIFO_FD);
    if (retval == Api->GO_ATEXIT)
      exit_me (0);

    Api.restore_app (;sigint = This.has.sigint ? handl : NULL);

    Rline.set (s);
    Rline.prompt (s, s._lin, s._col);
  end

  def appreconnect (s)
    Sock.send_int (SESSION_WRFIFO_FD, Api->APP_GET_CONNECTED);

    variable apps = Sock.get_str_ar (SESSION_RDFIFO_FD, SESSION_WRFIFO_FD);

    variable me = sprintf ("%s::%d", This.is.my.name, Env->PID);
    apps[where (me == apps)] = NULL;
    apps = apps[wherenot (_isnull (apps))];

    Rline.set (s);
    Rline.prompt (s, s._lin, s._col);

    variable saved = Input->rmap.right;
    Input->rmap.right = [saved, Input->F1];
    () = Rline.commandcmp (s, apps;already_filtered);
    Input->rmap.right = saved;

    ifnot (any (apps == s.argv[0]))
      return;

    if (s.argv[0] == This.is.my.name + "::" + string (Env->PID))
      return;

    Api.reset_app ();

    if (This.has.sigint)
      {
      variable handl;
      signal (SIGINT, SIG_IGN, &handl);
      }

    Sock.send_int (SESSION_WRFIFO_FD, Api->APP_RECON_OTH);
    () = Sock.get_int (SESSION_RDFIFO_FD);
    Sock.send_str (SESSION_WRFIFO_FD, s.argv[0]);

    variable retval = Sock.get_int (SESSION_RDFIFO_FD);

    if (retval == Api->GO_ATEXIT)
      exit_me (0);

    Api.restore_app (;sigint = This.has.sigint ? handl : NULL);

    Rline.set (s);
    Rline.prompt (s, s._lin, s._col);
  end

  def idle ()
    if (This.has.sigint)
      {
      variable handl;
      signal (SIGINT, SIG_IGN, &handl);
      }

    Sock.send_int (SESSION_WRFIFO_FD, Api->GO_IDLED);
    variable retval = Sock.get_int (SESSION_RDFIFO_FD);

    if (This.has.sigint)
      signal (SIGINT, handl);

    return retval;
  end
end
