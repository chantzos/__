Input = __->__ ("Input", "Input", "/home/aga/chan/__/__/Input", 1, ["en_getch",
 "fun",
 "__getch",
 "get_el_lang",
 "is_tty_inited",
 "el_getch",
 "getmapname",
 "__tty_getch",
 "at_exit",
 "setlang",
 "get_en_lang",
 "toggle_map",
 "let",
 "getlang",
 "getch"], "Class::classnew::NULL");
Load.module ("getkey", "Input");

__->__ ("Input", "BSLASH", 0x2f, "Class::vset::NULL";const = 1, dtype = NULL);

static define BSLASH ()
{
__->__ ("Input",  "BSLASH", "Class::vget::BSLASH";getref);
}

__->__ ("Input", "QMARK", 0x3f, "Class::vset::NULL";const = 1, dtype = NULL);

static define QMARK ()
{
__->__ ("Input",  "QMARK", "Class::vget::QMARK";getref);
}

__->__ ("Input", "UP", 0x101, "Class::vset::NULL";const = 1, dtype = NULL);

static define UP ()
{
__->__ ("Input",  "UP", "Class::vget::UP";getref);
}

__->__ ("Input", "DOWN", 0x102, "Class::vset::NULL";const = 1, dtype = NULL);

static define DOWN ()
{
__->__ ("Input",  "DOWN", "Class::vget::DOWN";getref);
}

__->__ ("Input", "LEFT", 0x103, "Class::vset::NULL";const = 1, dtype = NULL);

static define LEFT ()
{
__->__ ("Input",  "LEFT", "Class::vget::LEFT";getref);
}

__->__ ("Input", "RIGHT", 0x104, "Class::vset::NULL";const = 1, dtype = NULL);

static define RIGHT ()
{
__->__ ("Input",  "RIGHT", "Class::vget::RIGHT";getref);
}

__->__ ("Input", "REDO", 0x10E, "Class::vset::NULL";const = 1, dtype = NULL);

static define REDO ()
{
__->__ ("Input",  "REDO", "Class::vget::REDO";getref);
}

__->__ ("Input", "UNDO", 0x10F, "Class::vset::NULL";const = 1, dtype = NULL);

static define UNDO ()
{
__->__ ("Input",  "UNDO", "Class::vget::UNDO";getref);
}

__->__ ("Input", "BACKSPACE", 0x110, "Class::vset::NULL";const = 1, dtype = NULL);

static define BACKSPACE ()
{
__->__ ("Input",  "BACKSPACE", "Class::vget::BACKSPACE";getref);
}

__->__ ("Input", "IC", 0x112, "Class::vset::NULL";const = 1, dtype = NULL);

static define IC ()
{
__->__ ("Input",  "IC", "Class::vget::IC";getref);
}

__->__ ("Input", "DELETE", 0x113, "Class::vset::NULL";const = 1, dtype = NULL);

static define DELETE ()
{
__->__ ("Input",  "DELETE", "Class::vget::DELETE";getref);
}

__->__ ("Input", "F1", 0x201, "Class::vset::NULL";const = 1, dtype = NULL);

static define F1 ()
{
__->__ ("Input",  "F1", "Class::vget::F1";getref);
}

__->__ ("Input", "F2", 0x202, "Class::vset::NULL";const = 1, dtype = NULL);

static define F2 ()
{
__->__ ("Input",  "F2", "Class::vget::F2";getref);
}

__->__ ("Input", "F3", 0x203, "Class::vset::NULL";const = 1, dtype = NULL);

static define F3 ()
{
__->__ ("Input",  "F3", "Class::vget::F3";getref);
}

__->__ ("Input", "F4", 0x204, "Class::vset::NULL";const = 1, dtype = NULL);

static define F4 ()
{
__->__ ("Input",  "F4", "Class::vget::F4";getref);
}

__->__ ("Input", "F5", 0x205, "Class::vset::NULL";const = 1, dtype = NULL);

static define F5 ()
{
__->__ ("Input",  "F5", "Class::vget::F5";getref);
}

__->__ ("Input", "F6", 0x206, "Class::vset::NULL";const = 1, dtype = NULL);

static define F6 ()
{
__->__ ("Input",  "F6", "Class::vget::F6";getref);
}

__->__ ("Input", "F7", 0x207, "Class::vset::NULL";const = 1, dtype = NULL);

static define F7 ()
{
__->__ ("Input",  "F7", "Class::vget::F7";getref);
}

__->__ ("Input", "F8", 0x208, "Class::vset::NULL";const = 1, dtype = NULL);

static define F8 ()
{
__->__ ("Input",  "F8", "Class::vget::F8";getref);
}

__->__ ("Input", "F9", 0x209, "Class::vset::NULL";const = 1, dtype = NULL);

static define F9 ()
{
__->__ ("Input",  "F9", "Class::vget::F9";getref);
}

__->__ ("Input", "F10", 0x20a, "Class::vset::NULL";const = 1, dtype = NULL);

static define F10 ()
{
__->__ ("Input",  "F10", "Class::vget::F10";getref);
}

__->__ ("Input", "F11", 0x20b, "Class::vset::NULL";const = 1, dtype = NULL);

static define F11 ()
{
__->__ ("Input",  "F11", "Class::vget::F11";getref);
}

__->__ ("Input", "F12", 0x20c, "Class::vset::NULL";const = 1, dtype = NULL);

static define F12 ()
{
__->__ ("Input",  "F12", "Class::vget::F12";getref);
}

__->__ ("Input", "CTRL_a", 0x1, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_a ()
{
__->__ ("Input",  "CTRL_a", "Class::vget::CTRL_a";getref);
}

__->__ ("Input", "CTRL_b", 0x2, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_b ()
{
__->__ ("Input",  "CTRL_b", "Class::vget::CTRL_b";getref);
}

__->__ ("Input", "CTRL_d", 0x4, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_d ()
{
__->__ ("Input",  "CTRL_d", "Class::vget::CTRL_d";getref);
}

__->__ ("Input", "CTRL_e", 0x5, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_e ()
{
__->__ ("Input",  "CTRL_e", "Class::vget::CTRL_e";getref);
}

__->__ ("Input", "CTRL_f", 0x6, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_f ()
{
__->__ ("Input",  "CTRL_f", "Class::vget::CTRL_f";getref);
}

__->__ ("Input", "CTRL_h", 0x8, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_h ()
{
__->__ ("Input",  "CTRL_h", "Class::vget::CTRL_h";getref);
}

__->__ ("Input", "CTRL_j", 0xa, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_j ()
{
__->__ ("Input",  "CTRL_j", "Class::vget::CTRL_j";getref);
}

__->__ ("Input", "CTRL_k", 0xb, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_k ()
{
__->__ ("Input",  "CTRL_k", "Class::vget::CTRL_k";getref);
}

__->__ ("Input", "CTRL_l", 0xc, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_l ()
{
__->__ ("Input",  "CTRL_l", "Class::vget::CTRL_l";getref);
}

__->__ ("Input", "CTRL_n", 0xe, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_n ()
{
__->__ ("Input",  "CTRL_n", "Class::vget::CTRL_n";getref);
}

__->__ ("Input", "CTRL_o", 0xf, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_o ()
{
__->__ ("Input",  "CTRL_o", "Class::vget::CTRL_o";getref);
}

__->__ ("Input", "CTRL_p", 0x10, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_p ()
{
__->__ ("Input",  "CTRL_p", "Class::vget::CTRL_p";getref);
}

__->__ ("Input", "CTRL_r", 0x12, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_r ()
{
__->__ ("Input",  "CTRL_r", "Class::vget::CTRL_r";getref);
}

__->__ ("Input", "CTRL_t", 0x14, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_t ()
{
__->__ ("Input",  "CTRL_t", "Class::vget::CTRL_t";getref);
}

__->__ ("Input", "CTRL_u", 0x15, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_u ()
{
__->__ ("Input",  "CTRL_u", "Class::vget::CTRL_u";getref);
}

__->__ ("Input", "CTRL_v", 0x16, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_v ()
{
__->__ ("Input",  "CTRL_v", "Class::vget::CTRL_v";getref);
}

__->__ ("Input", "CTRL_w", 0x17, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_w ()
{
__->__ ("Input",  "CTRL_w", "Class::vget::CTRL_w";getref);
}

__->__ ("Input", "CTRL_x", 0x18, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_x ()
{
__->__ ("Input",  "CTRL_x", "Class::vget::CTRL_x";getref);
}

__->__ ("Input", "CTRL_y", 0x19, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_y ()
{
__->__ ("Input",  "CTRL_y", "Class::vget::CTRL_y";getref);
}

__->__ ("Input", "CTRL_z", 0x1a, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_z ()
{
__->__ ("Input",  "CTRL_z", "Class::vget::CTRL_z";getref);
}

__->__ ("Input", "CTRL_BSLASH", 0x1c, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_BSLASH ()
{
__->__ ("Input",  "CTRL_BSLASH", "Class::vget::CTRL_BSLASH";getref);
}

__->__ ("Input", "CTRL_BRACKETRIGHT", 0x1d, "Class::vset::NULL";const = 1, dtype = NULL);

static define CTRL_BRACKETRIGHT ()
{
__->__ ("Input",  "CTRL_BRACKETRIGHT", "Class::vget::CTRL_BRACKETRIGHT";getref);
}

__->__ ("Input", "ESC_esc", 0x1001a, "Class::vset::NULL";const = 1, dtype = NULL);

static define ESC_esc ()
{
__->__ ("Input",  "ESC_esc", "Class::vget::ESC_esc";getref);
}

__->__ ("Input", "ESC_q", 0x10070, "Class::vset::NULL";const = 1, dtype = NULL);

static define ESC_q ()
{
__->__ ("Input",  "ESC_q", "Class::vget::ESC_q";getref);
}

__->__ ("Input", "PPAGE", strncmp("st-",Env->TERM,3)?0x105:0x10a, "Class::vset::NULL";const = 1, dtype = NULL);

static define PPAGE ()
{
__->__ ("Input",  "PPAGE", "Class::vget::PPAGE";getref);
}

__->__ ("Input", "NPAGE", strncmp("st-",Env->TERM,3)?0x106:0x10d, "Class::vset::NULL";const = 1, dtype = NULL);

static define NPAGE ()
{
__->__ ("Input",  "NPAGE", "Class::vget::NPAGE";getref);
}

__->__ ("Input", "HOME", strncmp("st-",Env->TERM,3)?0x107:0x109, "Class::vset::NULL";const = 1, dtype = NULL);

static define HOME ()
{
__->__ ("Input",  "HOME", "Class::vget::HOME";getref);
}

__->__ ("Input", "END", strncmp("st-",Env->TERM,3)?0x108:0x10c, "Class::vset::NULL";const = 1, dtype = NULL);

static define END ()
{
__->__ ("Input",  "END", "Class::vget::END";getref);
}

__->__ ("Input", "rmap", struct    {
    osappnew = [F2, 0x10065], % Esc_f
    osapprec = [F1, 0x1006f], % Esc_p
    windmenu = [F3, 0x10076], % Esc_w
    battery = [F9, 0x10061],  % Esc_b
    changelang = [F10, 0x1006b], % Esc_l
    home = [HOME, CTRL_a],
    end = [END, CTRL_e],
    left = [LEFT, CTRL_b],
    right = [RIGHT, CTRL_f],
    backspace = [BACKSPACE, CTRL_h, 0x07F],
    delete = [DELETE],
    delword = [CTRL_w],
    deltoend = [CTRL_u],
    % last components in previous commands
    lastcmp = [0xae, 0x1f], % ALT + . (not supported from all terms), CTRL + _
    % keep the command line, execute another and re-enter the keep'ed command
    lastcur = [ESC_q],
    histup = [CTRL_r, UP],
    histdown = [DOWN],
    }, "Class::vset::NULL";const = 1, dtype = NULL);

static define rmap ()
{
__->__ ("Input",  "rmap", "Class::vget::rmap";getref);
}

private variable esc_pend=2;

private variable curlang=0;

private variable getchar_lang;;

private variable maps=Ref_Type[2];

private variable TTY_INITED=0;

private define el_getch ()
{
    variable
      esc_key = qualifier ("esc_key", 033),
      chr,
      index,
      vowel,
      el =  [[913:929:1], [931:937:1],[945:969:1],';',':'],
      eng = [
      'A','B','G','D','E','Z','H','U','I','K','L','M','N','J','O','P','R','S','T','Y',
      'F','X','C','V',
      'a','b','g','d','e','z','h','u','i','k','l','m','n','j','o','p','r','w', 's','t',
      'y','f','x','c','v','q','Q'],
      accent_vowels = ['ά','έ','ή','ί','ό','ύ','ώ','΄','Ά','Έ','Ό','Ί','Ώ','Ύ','Ή'],
      vowels_in_eng = ['a','e','h','i','o','y','v',';','A','E','O','I','V','Y','H'],
      ais = ['ϊ', 'ΐ', '¨'],
      ais_eng = ['i', ';', ':'];

    while (0 == input_pending (1));

    chr = getkey ();

    if (chr == esc_key)
      if (0 == input_pending (esc_pend))
  	    return esc_key;
      else
        chr = getkey () + 65535;

    if (';' == chr)
      {
      while (0 == input_pending (1));
      vowel = getkey ();
      index = wherefirst_eq (vowels_in_eng, vowel);
      if (NULL == index)
        return -1;
      else
        chr = accent_vowels[index];
      }
    else if (':' == chr)
      {
      while (0 == input_pending (1));
      vowel = getkey ();
      index = wherefirst_eq (ais_eng, vowel);
      if (NULL == index)
        return -1;
      else
        chr = ais[index];
      }
    else
      {
      index = wherefirst_eq (eng, chr);
      ifnot (NULL == index)
        chr = el[index];
      }

    chr;
}

private define en_getch ()
{
    variable
      esc_key = qualifier ("esc_key", 033),
      chr;

    while (0 == input_pending (1))
      continue;

    chr = getkey ();

    if (chr == esc_key)
      if (0 == input_pending (esc_pend))
  	    return esc_key;
      else
        chr = getkey () + 65535;

    chr;
}

private define toggle_map ()
{
    curlang = curlang == length (maps) - 1 ? 0 : curlang + 1;
    maps[curlang];
}

private define is_tty_inited (self)
{
    TTY_INITED;
}

__->__ ("Input", "is_tty_inited", &is_tty_inited, 0, 1, "Class::setfun::__initfun__");

private define __getch ()
{
    ifnot (TTY_INITED)
      {
      init_tty (-1, 0, 0);
      TTY_INITED = @(__get_reference ("Input->TTY_Inited"));
      }

    esc_pend = qualifier ("esc_pend", 2);

    variable chr = (@getchar_lang) (;;__qualifiers ());
    while (any ([-1, 0] == chr))
      chr = (@getchar_lang) (;;__qualifiers ());

    if (any (rmap.changelang == chr))
      if (qualifier_exists ("disable_langchange"))
        chr;
      else
        {
        getchar_lang = toggle_map ();

        variable callbackf = qualifier ("on_lang");
        variable args = qualifier ("on_lang_args");

        ifnot (NULL == callbackf)
          ifnot (NULL == args)
            (@callbackf) (__push_list (args));
          else
            (@callbackf);

        Input.getch ();
        }
    else
      chr;
}

private define __tty_getch ()
{
    variable ch;
    () = system ("stty raw");
    () = fread_bytes (&ch, 1, stdin);
    () = system ("stty sane");
    ch[0];
}

private define getch (self)
{
    (@[&__tty_getch, &__getch][This.is_smg ()]) ();
}

__->__ ("Input", "getch", &getch, 0, 1, "Class::setfun::__initfun__");

private define get_en_lang (self)
{
    &en_getch;
}

__->__ ("Input", "get_en_lang", &get_en_lang, 0, 1, "Class::setfun::__initfun__");

private define get_el_lang (self)
{
    &el_getch;
}

__->__ ("Input", "get_el_lang", &get_el_lang, 0, 1, "Class::setfun::__initfun__");

private define getmapname (self)
{
    strup (substr (string (maps[curlang]), 2, 2));
}

__->__ ("Input", "getmapname", &getmapname, 0, 1, "Class::setfun::__initfun__");

private define getlang (self)
{
    maps[curlang];
}

__->__ ("Input", "getlang", &getlang, 0, 1, "Class::setfun::__initfun__");

private define setlang (self, lang)
{
    variable m = array_map (String_Type, &string, maps);
    m = array_map (String_Type, &substr, m, 2, 2);
    variable i = where (m == lang);

    if (NULL == i)
      return;

    getchar_lang = maps[i[0]];
    curlang = i[0];
}

__->__ ("Input", "setlang", &setlang, 1, 1, "Class::setfun::__initfun__");

private define at_exit (self)
{
    if (TTY_INITED)
      reset_tty ();

    TTY_INITED = @(__get_reference ("Input->TTY_Inited"));
}

__->__ ("Input", "at_exit", &at_exit, 0, 1, "Class::setfun::__initfun__");

    maps[0] = get_en_lang (NULL);
    maps[1] = get_el_lang (NULL);
    getchar_lang = maps[0];

private define Input_en_getch (self)
{
  __->__ (self, "Input::en_getch::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "en_getch", &Input_en_getch);

private define Input_fun ()
{
  variable args = __pop_list (_NARGS);
  list_append (args, "Input::fun::fun");
  __->__ (__push_list (args);;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "fun", &Input_fun);

private define Input___getch (self)
{
  __->__ (self, "Input::__getch::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "__getch", &Input___getch);

private define Input_get_el_lang (self)
{
  __->__ (self, "Input::get_el_lang::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "get_el_lang", &Input_get_el_lang);

private define Input_is_tty_inited (self)
{
  __->__ (self, "Input::is_tty_inited::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "is_tty_inited", &Input_is_tty_inited);

private define Input_el_getch (self)
{
  __->__ (self, "Input::el_getch::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "el_getch", &Input_el_getch);

private define Input_getmapname (self)
{
  __->__ (self, "Input::getmapname::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "getmapname", &Input_getmapname);

private define Input___tty_getch (self)
{
  __->__ (self, "Input::__tty_getch::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "__tty_getch", &Input___tty_getch);

private define Input_at_exit (self)
{
  __->__ (self, "Input::at_exit::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "at_exit", &Input_at_exit);

private define Input_setlang (self, arg1)
{
  __->__ (self, arg1, "Input::setlang::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "setlang", &Input_setlang);

private define Input_get_en_lang (self)
{
  __->__ (self, "Input::get_en_lang::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "get_en_lang", &Input_get_en_lang);

private define Input_toggle_map (self)
{
  __->__ (self, "Input::toggle_map::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "toggle_map", &Input_toggle_map);

private define Input_let (self, arg1, arg2)
{
  __->__ (self, arg1, arg2, "Input::let::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "let", &Input_let);

private define Input_getlang (self)
{
  __->__ (self, "Input::getlang::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "getlang", &Input_getlang);

private define Input_getch (self)
{
  __->__ (self, "Input::getch::@method@";;__qualifiers);
}
set_struct_field (__->__ ("Input", "Class::getself"), "getch", &Input_getch);
public variable Input =  __->__ ("Input", "Class::getself");
Input.let = Class.let;
Input.fun = Class.fun;
