class Sys
  let MACHINE = uname.machine;
  let OS = uname.sysname;

  def checkperm (mode, perm)
    Sys.modetoint (mode) == perm ? 0 : -1;
  end

  def setperm (file, perm)
    if (-1 == chmod (file, perm))
      {
      IO.tostderr ("couldn't set permissions,", errno_string (errno));
      return -1;
      }
    0;
  end

  def modetoint (mode)
    variable
      S_ISUID = 04000,    % Set user ID on execution
      S_ISGID = 02000,    % Set group ID on execution
      S_ISVTX = 01000,    % Save swapped text after use (sticky)
      CHMOD_MODE_BITS =  (S_ISUID|S_ISGID|S_ISVTX|S_IRWXU|S_IRWXG|S_IRWXO);

    atoi (sprintf ("%d", mode & CHMOD_MODE_BITS));
  end

  def which (exec)
    variable ar, path = Path->OS;

    if (NULL == path)
      return NULL;

    path = strchop (path, path_get_delimiter, 0);
    path = array_map (String_Type, &path_concat, path, exec);
    path = path [wherenot (array_map (Integer_Type, Dir.isdirectory, NULL, path))];

    ar = wherenot (array_map (Integer_Type, &access, path, X_OK));

    if (length (ar))
      path[ar][0];
    else
      NULL;
   end

  fun getgrname (gid)

  fun getpwname (uid)

  fun getpwuidgid (user)
end
