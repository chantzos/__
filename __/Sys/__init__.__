class Sys
  let MACHINE = uname.machine;
  let OS = uname.sysname;

  def checkperm (mode, perm)
    self.modetoint (mode) == perm ? 0 : -1;
  end

  def setperm (file, perm)
    if (-1 == chmod (file, perm))
      {
      IO.tostderr ("couldn't set permissions,", errno_string (errno));
      return -1;
      }
    0;
  end

  def modetoint (mode)
    variable
      S_ISUID = 04000,    % Set user ID on execution
      S_ISGID = 02000,    % Set group ID on execution
      S_ISVTX = 01000,    % Save swapped text after use (sticky)
      CHMOD_MODE_BITS =  (S_ISUID|S_ISGID|S_ISVTX|S_IRWXU|S_IRWXG|S_IRWXO);

    atoi (sprintf ("%d", mode & CHMOD_MODE_BITS));
  end

  def which (exec)
    variable ar, path = Env->OS_PATH;

    if (NULL == path)
      return NULL;

    path = strchop (path, path_get_delimiter, 0);
    path = array_map (String_Type, &path_concat, path, exec);
    path = path [wherenot (array_map (Integer_Type, Dir.isdirectory, NULL, path))];
    ar = wherenot (array_map (Integer_Type, &access, path, X_OK));

    if (length (ar))
      path[ar][0];
    else
      NULL;
   end

  def getgrname (gid)
    variable gr = getgrgid (gid);

    if (NULL == gr)
      if (errno)
        throw ClassError, "Sys::getgrname::" + errno_string (errno);
      else
        throw ClassError, "Sys::getgrname::cannot find the GID " + string (gid) +
         " in /etc/group, who are you?";

    gr.gr_name;
  end

  def getpwname (uid)
    variable pw =getpwuid (uid);

    if (NULL == pw)
      if (errno)
        throw ClassError, "Sys::getpwname::" + errno_string (errno);
      else
        throw ClassError, "Sys::getpwname::cannot find the UID " + string (uid) +
         " in /etc/passwd, who are you?";

    pw.pw_name;
  end

  fun getpwuidgid (user)
end
